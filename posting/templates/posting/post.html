{% extends 'base.html' %}
{% block content %}
{% load django_tables2 %}
{% load static %}

<div class="p-3">
  <div class="container">
    <div class="row mt-3">

      <div class="col-md-6 mb-3">
        <h2>{{ template_data.post.company_name }}</h2>
        <hr />

        <p><b>Job Title:</b> {{ template_data.post.job_title }}</p>
        <p><b>Description:</b> {{ template_data.post.description }}</p>

        {% if not user.is_authenticated or user != template_data.post.recruiter.user %}
          <button type="button"
                  class="primary-hover-btn"
                  data-bs-toggle="modal"
                  data-bs-target="#applyModal">
            Apply Now
          </button>
        {% endif %}

        {% if user.is_authenticated and user == template_data.post.recruiter.user %}
          <div class="mt-3 d-flex gap-2">
            <a href="{% url 'posting.edit' id=template_data.post.id %}"
               class="btn btn-outline-primary">
              Edit
            </a>

            <form method="POST"
                  action="{% url 'posting.delete' id=template_data.post.id %}"
                  onsubmit="return confirm('Are you sure you want to delete this post?');">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger">
                Delete
              </button>
            </form>
          </div>
        {% endif %}
      </div>

      <div class="col-md-6 mb-3 text-center">
        <img
          src="{{ template_data.post.image.url }}"
          class="rounded img-card-400 mb-3"
        />

        <h5>Required Skills</h5>
        <div class="d-flex flex-wrap justify-content-center gap-2">
          {% for skill in template_data.post.skills.all %}
            <span class="badge"
                  style="background-color: var(--primary); color: var(--text);">
              {{ skill.name }}
            </span>
          {% empty %}
            <span class="text-muted">No skills listed</span>
          {% endfor %}
        </div>
      </div>
      {% if template_data.table_access %}
      <div class="col-12">
        <h2>Candidate Pool</h2>
        <hr />
        <form method="GET" action="{% url 'posting.post' id=template_data.id %}" class="row g-2 mb-3 align-items-end">
          <div class="col-auto">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Name</span>
              <input type="text" class="form-control" name="search" value="{{ request.GET.search }}" placeholder="Search candidates">
            </div>
          </div>
          <div class="col-auto">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Status</span>
              <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                <option value="">All</option>
                <option value="Applied" {% if request.GET.status == "Applied" %}selected{% endif %}>Applied</option>
                <option value="Reviewed" {% if request.GET.status == "Reviewed" %}selected{% endif %}>Reviewed</option>
                <option value="Interview" {% if request.GET.status == "Interview" %}selected{% endif %}>Interview</option>
                <option value="Offer" {% if request.GET.status == "Offer" %}selected{% endif %}>Offer</option>
                <option value="Closed" {% if request.GET.status == "Closed" %}selected{% endif %}>Closed</option>
              </select>
            </div>
          </div>
          <div class="col-auto">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Skills</span>
              <select name="skills" class="form-select form-select-sm" onchange="this.form.submit()">
                <option value="">All Skills</option>
                {% for skill in template_data.skills %}
                  <option value="{{ skill.name }}" {% if request.GET.skills == skill.name %}selected{% endif %}>{{ skill.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-auto">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Sort by</span>
              <select name="sort" class="form-select form-select-sm" onchange="this.form.submit()">
                <option value="applicant__first_name" {% if request.GET.sort == "applicant__first_name" or not request.GET.sort %}selected{% endif %}>Name (A-Z)</option>
                <option value="-applicant__first_name" {% if request.GET.sort == "-applicant__first_name" %}selected{% endif %}>Name (Z-A)</option>
                <option value="status" {% if request.GET.sort == "status" %}selected{% endif %}>Status (A-Z)</option>
                <option value="-status" {% if request.GET.sort == "-status" %}selected{% endif %}>Status (Z-A)</option>
                <option value="message" {% if request.GET.sort == "message" %}selected{% endif %}>Message (A-Z)</option>
                <option value="-message" {% if request.GET.sort == "-message" %}selected{% endif %}>Message (Z-A)</option>
              </select>
            </div>
          </div>
        </form>
        <hr />
        {% if template_data.applications %}
          {% render_table template_data.applications %}
        {% else %}
          <p>No candidates have applied to this posting yet.</p>
        {% endif %}
      </div>
      {% endif %}

      {% if not user.is_authenticated or user != template_data.post.recruiter.user %}
      <div class="modal fade"
           id="applyModal"
           data-bs-backdrop="static"
           data-bs-keyboard="false"
           tabindex="-1"
           aria-labelledby="applyModalLabel"
           aria-hidden="true">

        <div class="modal-dialog">
          <div class="modal-content">
            <form method="POST"
                  action="{% url 'applications.apply' posting_id=template_data.id %}">
              {% csrf_token %}

              <div class="modal-header">
                <h1 class="modal-title fs-5" id="applyModalLabel">
                  <strong>Applying to role:</strong>
                  {{ template_data.post.job_title }} at {{ template_data.post.company_name }}
                </h1>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"></button>
              </div>

              <div class="modal-body">
                <div class="mb-3">
                  <label for="applicationMessage" class="form-label">
                    Optional Application Message
                  </label>
                  <textarea class="form-control"
                            id="applicationMessage"
                            name="message"
                            rows="3"
                            maxlength="1000"></textarea>
                  <div class="form-text">
                    Max. 1000 characters
                  </div>
                </div>
              </div>

              <div class="modal-footer">
                <button type="button"
                        class="btn secondary-hover-btn"
                        data-bs-dismiss="modal">
                  Cancel
                </button>
                <button type="submit"
                        class="btn primary-hover-btn">
                  Apply
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</div>

{% endblock content %}