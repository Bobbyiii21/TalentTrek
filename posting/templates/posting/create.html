{% extends 'base.html' %}
{% block content %}
{% load static %}

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="p-3">
  <div class="container">
    <div class="row mt-3">
      <div class="col-md-6 mx-auto mb-3">

        <h2> {% if editing %}Edit Job Posting{% else %}Create a Job Posting{% endif %}</h2>
        <hr />
        <form method="POST"
              action="{% if editing %}
                        {% url 'posting.edit' id=post.id %}
                      {% else %}
                        {% url 'posting.create' %}
                      {% endif %}"
              enctype="multipart/form-data">
          {% csrf_token %}
          <label for="job_title"><b>Job Title:</b> *</label>
          <input
            name="job_title"
            required
            class="form-control"
            id="job_title"
            type="text"
            value="{{ post.job_title|default:'' }}"
          />

          <p class="mt-3">
            <label for="description"><b>Job Description:</b></label>
            <textarea
              name="description"
              class="form-control"
              id="description"
            >{{ post.description|default:'' }}</textarea>
          </p>

          <p>
            <label for="job_type"><b>Job Type:</b></label>
            <select name="job_type" id="job_type" required>
              {% for value, label in job_type_choices %}
                <option value="{{ value }}"
                        {% if post.job_type == value %}selected{% endif %}>
                  {{ label }}
                </option>
              {% endfor %}
            </select>

            <br><br>
            <label for="location_type"><b>Location Type:</b></label>
            <select name="location_type" id="location_type" required>
              {% for value, label in location_type_choices %}
                <option value="{{ value }}"
                        {% if post.location_type == value %}selected{% endif %}>
                  {{ label }}
                </option>
              {% endfor %}
            </select>

            <div class="d-flex align-items-center mb-0 mt-2">
              <label class="form-check-label" for="visa_sponsorship">
                <b>Visa sponsorship available:</b>
              </label>
              <input
                class="form-check-input order-last ms-2"
                type="checkbox"
                name="visa_sponsorship"
                id="visa_sponsorship"
                {% if post.visa_sponsorship %}checked{% endif %}
              >
            </div>
          </p>

          <div class="mb-4">
            <label class="form-label"><b>Salary Range (USD):</b></label>

            <div class="d-flex justify-content-between mb-2">
              <span id="salaryMinLabel">${{ post.salary_min|default:"40" }}k</span>
              <span id="salaryMaxLabel">${{ post.salary_max|default:"120" }}k</span>
            </div>

            <div class="position-relative">
              <input
                type="range"
                id="salary_min"
                name="salary_min"
                min="30"
                max="300"
                step="1"
                value="{{ post.salary_min|default:'40' }}"
                class="form-range"
              />
              <input
                type="range"
                id="salary_max"
                name="salary_max"
                min="30"
                max="300"
                step="1"
                value="{{ post.salary_max|default:'120' }}"
                class="form-range mt-n2"
              />
            </div>
          </div>

          <p>
            <label><b>Location:</b></label>
            <input id="country" name="country"
                   class="form-control"
                   placeholder="Country"
                   value="{{ post.country|default:'' }}">
          </p>
          <div class="row">
            <div class="col-md-5 mb-2">
              <input id="city" name="city"
                     class="form-control"
                     placeholder="City"
                     value="{{ post.city|default:'' }}">
            </div>
            <div class="col-md-3 mb-2">
              <input id="state" name="state"
                     class="form-control"
                     placeholder="State"
                     value="{{ post.state|default:'' }}">
            </div>

            <div class="col-md-4 mb-2">
              <input id="postal_code" name="postal_code"
                     class="form-control"
                     placeholder="ZIP / Postal Code"
                     value="{{ post.postal_code|default:'' }}">
            </div>

            <div class="col-12">
              <input id="street" name="street"
                     class="form-control mb-2"
                     placeholder="Street"
                     value="{{ post.street|default:'' }}">
            </div>
          </div>

          <div class="mb-3">
            <label for="image" class="form-label">
              <b>Upload a Job Image:</b>
            </label>
            <input class="form-control"
                   type="file"
                   name="image"
                   id="image"
                   accept="image/*">
            {% if editing %}
              <small class="text-muted">Leave empty to keep current image</small>
            {% endif %}
          </div>
          <div class="mb-3">
            <label for="skills" class="form-label">
              <b>Required Skills:</b>
            </label>
            <select name="skills" id="skills" class="form-select" multiple>
              {% for skill in skills %}
                <option value="{{ skill.id }}"
                        {% if post and skill in post.skills.all %}selected{% endif %}>
                  {{ skill.name }}
                </option>
              {% endfor %}
            </select>
          </div>


          <button type="submit" class="btn bg-dark text-white w-100">
            {% if editing %}Save Changes{% else %}Create Job Posting{% endif %}
          </button>

        </form>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    $("#skills").select2({
      placeholder: "Search and select skills",
      allowClear: true,
      width: "resolve",
    });
  });
</script>

<script>
  $(document).ready(function () {
    const $country = $("#country");
    const $city = $("#city");
    const $street = $("#street");
    const $state = $("#state");
    const $postal_code = $("#postal_code");

    function updateLocationFields() {
      const hasCountry = $country.val().trim() !== "";
      const hasCity = $city.val().trim() !== "";
      const hasStreet = $street.val().trim() !== "";

      $city.prop("disabled", !hasCountry);
      if (!hasCountry) {
        $city.val("");
        $street.val("");
        $state.val("");
        $postal_code.val("");
      }

      $state.prop("disabled", !hasCountry);
      if (!hasCountry) {
        $city.val("");
        $street.val("");
        $state.val("");
        $postal_code.val("");
      }

      $street.prop("disabled", !(hasCountry && hasCity));
      if (!hasCity) {
        $street.val("");
      }

      $postal_code.prop("disabled", !(hasCountry && hasCity && hasStreet));
      if (!hasStreet) {
        $postal_code.val("");
      }
    }

    $country.on("input", updateLocationFields);
    $city.on("input", updateLocationFields);
    $street.on("input", updateLocationFields);

    updateLocationFields();
  });
</script>

<script>
  $(document).ready(function () {
    const $min = $("#salary_min");
    const $max = $("#salary_max");
    const $minLabel = $("#salaryMinLabel");
    const $maxLabel = $("#salaryMaxLabel");
    const gap = 5;

    function format(val) {
      return "$" + Number(val).toLocaleString() + "K";
    }
    function updateSalary() {
      let minVal = parseInt($min.val());
      let maxVal = parseInt($max.val());
      if (maxVal - minVal < gap) {
        if (this === $min[0]) {
          $min.val(maxVal - gap);
          minVal = maxVal - gap;
        } else {
          $max.val(minVal + gap);
          maxVal = minVal + gap;
        }
      }
      $minLabel.text(format($min.val()));
      $maxLabel.text(format($max.val()));
    }
    $min.on("input", updateSalary);
    $max.on("input", updateSalary);
    updateSalary();
  });
</script>

{% endblock content %}